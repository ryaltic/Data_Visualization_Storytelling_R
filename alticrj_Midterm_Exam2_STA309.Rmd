---
title: "STA309_Midterm_Exam2"
author: "Ryan Altic"
date: "2024-04-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Loading necessary packages

```{r}
library(tidyverse)
library(patchwork)
```
### Reading in the data

```{r}
dairyproduction_url = ("https://raw.githubusercontent.com/oconnellmj/sta309/main/milk-production-tonnes.csv")
dairyconsumption_url = ("https://raw.githubusercontent.com/oconnellmj/sta309/main/per-capita-milk-consumption.csv")

dairyproduction = read_csv(url(dairyproduction_url))
dairyproduction <- dairyproduction %>%
  filter(Year >= 2011) %>%
  filter(Year <= 2021) %>%
  filter(Entity != "French Guiana") %>%
  filter(Entity != "Trinidad and Tobago")

dairyconsumption = read_csv(url(dairyconsumption_url)) %>%
  filter(Year >= 2011) %>%
  filter(Entity != "French Guiana") %>%
  filter(Entity != "Trinidad and Tobago")

```
# Preprocessing

```{r}
south_america <- map_data("world") %>%
  filter(long <= -35) %>%
  filter(long >= -81) %>%
  filter(lat >= -55) %>%
  filter(lat <= 12) %>%
  filter(region != "Falkland Islands") %>%
  filter(region != "South Georgia") %>%
  filter(region != "French Guiena") %>%
  filter(region != "Tobago") %>%
  filter(region != "Trindad")
  

south_america_centroids <- south_america %>% 
  group_by(region) %>%
  summarize_at(vars(long, lat), ~ mean(range(.)))

Code <- dairyconsumption %>%
  group_by(Entity,Code) %>%
  summarise(meanmilk = mean(`Milk consumption (kilograms per year per capita)`))%>%
  select(Entity,Code)

south_america_code <- Code %>%
  right_join(south_america_centroids, by = c("Entity" = "region"))

dairyconsumption_SA <- dairyconsumption %>%
  right_join(south_america, by = c("Entity" ="region"))

dairyproduction_SA <- dairyproduction %>%
  right_join(south_america, by = c("Entity" ="region"))

mean.consumption <- dairyconsumption_SA %>%
  filter(Year >= 2011) %>%
  group_by(Entity)%>%
  summarise(mean_consumption = mean(`Milk consumption (kilograms per year per capita)`))

dairyconsumption_SA <- dairyconsumption_SA %>%
  right_join(mean.consumption, by = "Entity")

mean.production <- dairyproduction_SA %>%
  filter(Year >= 2011) %>%
  group_by(Entity)%>%
  summarise(mean_production = mean(`Milk Production (tonnes)`))

dairyproduction_SA <- dairyproduction_SA %>%
  right_join(mean.production, by = "Entity")

dairyconsumption_SA <- dairyconsumption_SA %>%
  select(-Code,-order,-subregion)
  
dairyproduction_SA <- dairyproduction_SA %>%
  select(-Code,-order,-subregion)
  
```



# Plot of Dairy Consumption

```{r}

p.DC <-ggplot(data= dairyconsumption_SA, aes(x=long,y=lat)) +
  geom_polygon(aes(color=Entity,group=group, fill=mean_consumption),color = "gray20")+
  geom_text(data=south_america_code,aes(label=Code),color="gray15",fontface="bold",
            size =3.5)+
  coord_map("conic", lat0=-23) +
  scale_fill_gradient(low="gray95",high = "blue3")+
  annotate("text",x=-55,y=15, label = "Mean Dairy Consumption", fontface="bold",
           size=4) +
  labs(x=element_blank(),
       y=element_blank(),
       fill ="Milk consumption \n(kg per capita)") +
  theme_minimal()+
  theme()
```

# Plot of Dairy Production

```{r}

p.DP <- ggplot(data= dairyproduction_SA, aes(x=long,y=lat)) +
  geom_polygon(aes(group=group,color=Entity,fill=mean_production),color = "gray20")+
  geom_text(data=south_america_code,aes(label=Code),color="gray15",fontface="bold",
            size = 3.5)+
  coord_map("conic", lat0=-23) +
  scale_fill_gradient(low="gray95",high = "orange3", label=c("0","10","20","30","40"))+
  annotate("text",x=-55,y=15, label = "Mean Dairy Production", fontface="bold",
           size=4) +
  labs(x=element_blank(),
       y=element_blank(),
       fill ="Milk Production \n(millions of tonnes)") +
  theme_minimal()
```

# Plot of Dairy Consumption over time

```{r}
p.DCline <- ggplot(data=dairyconsumption_SA) +
  geom_line(data=dairyconsumption_SA %>% filter(Entity != "Uruguay"),aes(x=Year, y=`Milk consumption (kilograms per year per capita)`,
                group = Entity, color = Entity),color="gray70") +
  geom_line(data = dairyconsumption_SA %>% filter(Entity == "Uruguay"), aes(x=Year,y=`Milk consumption (kilograms per year per capita)`),color="blue")+
  annotate("label",x=2018,y=200, label = "Uruguay",color="blue2",fontface="bold")+
  labs(x=element_blank(),
       y=element_blank(),
       title = "Diary Consumption (kg per capita)")+
  scale_x_continuous(breaks = c(2011,2016,2021), labels = c("2011","'16","'21"))+
  coord_cartesian(expand = F) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())
```

# Plot of Dairy Production over time

```{r}
p.DPline <- ggplot(data=dairyproduction_SA) +
    geom_line(data=dairyproduction_SA %>% filter(Entity != "Uruguay"),aes(x=Year, y=`Milk Production (tonnes)`,group = Entity, color = Entity),color="gray70") +
  geom_line(data = dairyproduction_SA %>% filter(Entity == "Uruguay"), aes(x=Year,y=`Milk Production (tonnes)`),color="blue")+
  annotate("label",x=2015,y=4000000, label = "Uruguay",color="blue2",fontface="bold")+
  labs(x=element_blank(),
       y=element_blank(),
       title = "Diary Production (millions of tonnes)")+
  scale_x_continuous(breaks = c(2011,2016,2021), labels = c("2011","'16","'21"))+
  scale_y_continuous(breaks= c(5000000,10000000,15000000,20000000,25000000,30000000,35000000),labels = c("5" ,"10","15","20","25","30","35"))+
  coord_cartesian(expand = F) +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())
```

# Plot of relationship between dairy production and consumption

```{r}

dairy_prod_2021 <- dairyproduction_SA %>%
  filter(Year ==2021) %>%
  select(-`Milk Production (tonnes)`)

dairy_cons_2021 <- dairyconsumption_SA %>%
  filter(Year==2021) %>%
  select(-`Milk consumption (kilograms per year per capita)`)


dairy_prod_cons <- merge(dairy_cons_2021,dairy_prod_2021)

dairy_prod_cons<- dairy_prod_cons %>%
  mutate(Ratio_prod_by_cons= mean_production/mean_consumption) %>%
  mutate(num = 1) %>%
  group_by(Entity,Ratio_prod_by_cons) %>%
  summarise(dum <- mean(num)) %>%
  select(Entity,Ratio_prod_by_cons)

dairy_prodcons_SA <- dairy_prod_cons %>%
  right_join(south_america, by = c("Entity" = "region"))

p.R <- ggplot(data= dairy_prodcons_SA, aes(x=long,y=lat)) +
  geom_polygon(aes(color=Entity,group=group, fill=Ratio_prod_by_cons),color = "gray20")+
  geom_text(data=south_america_code,aes(label=Code),color="gray15",fontface="bold",
            size =3.5)+
  coord_map("conic", lat0=-23) +
  scale_fill_gradient(low="gray95",high = "green3", label = c("0","50","100","150","200","250"))+
  annotate("text",x=-55,y=15, label = "Dairy Produced per \nDairy Consumed", fontface="bold",
           size=4) +
  labs(x=element_blank(),
       y=element_blank(),
       fill ="Ratio of Dairy produced by \nDairy consumed (kg per \ncapita per tonnes in thousands)") +
  annotate("text",x=-40,y=-50,label= "Greenish countries \nproduce way more \ndairy \nthan they \nconsume", size=3,fontface="bold") +
  theme_minimal()+
  theme(legend.position = "bottom",
        legend.title = element_text(size=7))

```

# Dashboard and PNG

```{r}
Dashboard <- (p.DPline)/(p.DCline)/(p.DP | p.DC | p.R) +
  plot_annotation(title = "South American Countries' dairy consumption and dairy production (2011-2021)",
                  subtitle = "Uruguay consumes a lot of dairy and does not produces a lot of diary when compared to other South America Countries",
                  caption = "Source: OurWorldInData.org and Food and Agriculture Organization of the United Nations") 


ggsave(plot = Dashboard, filename = "SouthAmerica_Dairy.png",
       width = 13,height = 15,dpi=600)
```

